<?php
module_load_include('inc', 'bibdk_searchhistory', 'bibdk_searchhistory.form');
module_load_include('inc', 'bibdk_searchhistory', 'bibdk_searchhistory.block');
module_load_include('inc', 'bibdk_searchhistory', 'bibdk_searchhistory.webservice');
module_load_include('inc', 'bibdk_searchhistory', 'includes/bibdk_searchhistory.mypage');


/**
 * @file
 * Adding support for saving and reuse of old searches
 */

/**
 * Impelements user_profile_tabs (
 * @see ding_user.module)
 * */
function bibdk_searchhistory_user_profile2_tabs() {
  
  $ret = new stdClass();
  $ret->label = t('searchhistory');
  $ret->form = 'bibdk_searchhistory_form';
  $ret->type = 'bibdk_search_history';
  
  return $ret;
}

/**
 * Implements hook_menu().
 * Sets up menu items.
 *
 */
function bibdk_searchhistory_menu() {
  $items = array();
  $items['bibdk_searchhistory/ajax/%/%'] = array(
    'page callback' => 'bibdk_searchhistory_action_link_callback',
    'page arguments' => array(2, 3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  $items['admin/config/search/bibdk_searchhistory'] = array(
    'title' => 'Bibdk search history',
    'description' => 'Settings for display of search history',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_searchhistory_admin'),
    'access arguments' => array('administer bibdk search history settings'),
    'file' => 'includes/bibdk_searchhistory_settings.admin.inc',
  );

  $items['user/searchhistory'] = array(
    'title' => 'Search history',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bibdk_searchhistory_form'),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function bibdk_searchhistory_permission() {
  return array(
    'administer bibdk search history settings' => array(
      'title' => t('Administer search history settings'),
      'description' => t('Allow users to modify settings for search history'),
    ),
  );
}

/**
 * Implement hook_ctools_plugin_api().
 */
function bibdk_searchhistory_ctools_plugin_api($module, $api) {
  if ($module == 'page_manager' && $api == 'pages_default') {
    return array('version' => 1);
  }
}

/**
 * Implements hook_ting_openformat_search_results.
 *
 * Called from ting_search when a search is being executed.
 * Saves the search string and number of results in the $_SESSION variable
 *
 * @param String $keys - searchstring
 * @param int $searchsresult - result count
 * @param array $conditions
 * @param String $params
 */
function bibdk_searchhistory_ting_openformat_search_results($keys, $searchsresult, $params) {
  $element = array(
    'string' => (isset($keys) && !empty($keys)) ? $keys : bibdk_searchhistory_parse_params($params),
    'params' => $params,
    'count' => isset($searchsresult->numTotalObjects) ? $searchsresult->numTotalObjects : 0,
    'timestamp' => time(),
  );
  BibdkSearchHistory::addElementToSession($element);
}
